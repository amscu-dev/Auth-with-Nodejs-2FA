openapi: 3.1.0
info:
  title: API for Password, Passkey, Magic Link, and OIDC Authentication
  description: >
    API for user registration and authentication using multiple methods:
    username/password with capability of 2fa, passkey (WebAuthn), magic link, and OIDC providers (Google, GitHub, etc.).
  contact:
    name: Marinescu Alexandru
    email: amarinescu.dev@gmail.com
  license:
    name: Apache License 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  version: 1.0.0
servers:
  - url: https://accounts.authportal.com/api/v1
    description: Production Server
paths:
  /auth/register:
    post:
      tags: [Email & Password Auth]
      summary: Register a new user
      description: This endpoint allows a new user to create an account using their email and password. After registration, the user must verify their email to complete the registration process successfully.
      requestBody:
        required: true
        description: Request body for user registration.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRegistrationRequestBody"
      responses:
        "201":
          description: Registration successful. A verification email has been sent, the user must confirm their email to complete the signup process.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegistrationSuccessReponse"
        "400":
          description: Bad Request — validation failed or user already exists.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/EmailAlreadyExistsError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/InvalidRequestBodyValidationError"
  /auth/login:
    post:
      tags: [Email & Password Auth]
      summary: Authenticate a user with email and password
      description: >
        This endpoint allows an existing user to log in using their email and password.
        Upon successful authentication, an access token (and optionally a refresh token) is returned.
        If the user has two-factor authentication enabled, additional steps may be required to complete the login process.
      requestBody:
        required: true
        description: Credentials for user login
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserLoginRequestBody"
      responses:
        "200":
          description: >
            Authentication response. Depending on the user's status, one of the following outcomes is returned:
            1. Email not verified — user must confirm their email to proceed.
            2. Two-factor authentication required — user must complete MFA to finalize login.
            3. Authentication successful — user credentials are valid, and access/refresh tokens are provided.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
            Set-Cookie:
              $ref: "#/components/headers/AuthenticationCookies"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/LoginEmailVerificationPendingResponse"
                  - $ref: "#/components/schemas/MFAPendingResponse"
                  - $ref: "#/components/schemas/LoginSuccessResponse"
        "404":
          description: >
            User not found — no account exists with the provided email address. 
            The client should prompt the user to register before attempting login.
          content:
            application/json:
              schema:
                $ref: ".../spec/schemas/reusable/errors/openapi.yaml/components/schemas/UserNotFoundError"
        "400":
          description: >
            Invalid credentials — the provided email or password is incorrect. 
            The client should notify the user and allow them to retry authentication.
          content:
            application/json:
              schema:
                $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/InvalidCredentialsError"
  /auth/email/verify:
    post:
      tags: [Email & Password Auth]
      summary: Authenticate a user with email and password
      description: >
        Verifies a user's email address using a verification token sent via email.
        Upon successful verification, the user's account is marked as confirmed, allowing them to complete the login process or other protected actions.
      requestBody:
        required: true
        description: Verify a user's email address
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  example: n3910310n013912310sa
      responses:
        "200":
          description: >
            Email verification successful. The user's email address has been confirmed, enabling them to complete the login process and access protected resources.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmailConfirmedSuccessResponse"
        "404":
          description: >
            Verification failed, the provided verification code was not found.
            This may happen if the code is invalid or never issued. The user should request a new verification code.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeNotFoundError"
        "400":
          description: >
            Verification failed due to an invalid verification code state:
            1. The code has expired — the user must request a new verification code.
            2. The code has already been consumed — the user must request a new verification code.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeExpiredError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeConsumedError"
  /auth/password/forgot:
    post:
      tags: [Email & Password Auth]
      summary: Request a password reset for a user account
      description: >
        Initiates the password reset process for a user by submitting their email address. 
        If the user has two-factor authentication (MFA) enabled, an MFA verification step will be required before sending the password reset instructions. Otherwise, a password reset email will be sent directly.
      requestBody:
        required: true
        description: Email address of the user requesting a password reset
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ForgotPasswordRequestBody"
      responses:
        "200":
          description: >
            Password reset request processed successfully. Depending on the user's account configuration:
            1. MFA pending — if the user has two-factor authentication enabled, an MFA verification step is required before sending the reset email.
            2. Reset email sent — if MFA is not enabled, a password reset email has been sent with instructions to reset the password.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
            Set-Cookie:
              $ref: "#/components/headers/MFATokenCookie"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/MFAPendingResponse"
                  - $ref: "#/components/schemas/ForgotPasswordSuccessResponse"
        "404":
          description: >
            User not found — no account exists for the provided email address. Ensure the email is correct and try again.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/UserNotFoundError"
        "503":
          description: >
            Email service unavailable — the system could not send the password reset email due to a temporary email service failure. Retry the request later.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/EmailServiceError"
  /auth/password/reset:
    patch:
      tags: [Email & Password Auth]
      summary: Complete the password reset process
      description: >
        Completes the password reset process for a user account using a valid verification code.  
        The request must include the verification code (typically received via email) and the new password.  
        Upon successful verification, the user's password is updated, existing authentication cookies are cleared,  
        and the user is advised to log in again. If the password reset was not initiated by the user, they are encouraged  
        to contact support immediately. The operation also records contextual information such as IP address and user agent  
        for security auditing purposes.
      requestBody:
        required: true
        description: x
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetPasswordRequestBody"
      responses:
        "200":
          description: >
            Password reset completed successfully.  
            All existing authentication cookies are invalidated to ensure previous sessions are closed.  
            The user should proceed to log in with the new password.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
            Set-Cookie:
              $ref: "#/components/headers/InvalidateAuthenticationCookies"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResetPasswordSuccessResponse"
        "404":
          description: >
            The provided verification code or associated user could not be found.  
            This may occur if the code is invalid or the user no longer exists in the system.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeNotFoundError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/UserNotFoundError"
        "400":
          description: >
            The password reset request could not be completed due to invalid or expired data.  
            Possible causes include:
            - The verification code has expired or was already consumed.  
            - The new password does not meet security requirements or was previously used.  
            The client should prompt the user to request a new password reset code and try again.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeExpiredError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/VerificationCodeConsumedError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/PasswordReuseNotAllowed"
  /auth/refresh:
    get:
      security:
        - RefreshTokenCokie: []
      tags: [Email & Password Auth]
      summary: Refresh the user's access token using a valid refresh token
      description: >
        Issues a new access token (and optionally a new refresh token) for an authenticated session.  
        The request must include a valid **refresh token** stored in the user's HTTP-only cookie. If the refresh token is valid and the session is still active, a new access token will be returned and authentication cookies will be updated.  
        If the refresh token is expired, invalid, or mismatched, the session will be invalidated and all authentication cookies will be cleared to enforce re-authentication.  
        This endpoint ensures seamless session continuity while maintaining security best practices.
      responses:
        "200":
          description: >
            Access token successfully refreshed.  
            The user's session remains active, and new authentication cookies are set.  
            If a new refresh token was issued, it replaces the previous one automatically.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
            Set-Cookie:
              $ref: "#/components/headers/AuthenticationCookies"
          content:
            application/json:
              schema:
                $ref: "#/components/schema/RefreshTokenEndpointSuccessResponse"
        "401":
          description: >
            The refresh token is invalid, expired, missing, or does not match the current session.  
            All authentication cookies are invalidated to prevent unauthorized access,  
            and the user must log in again to obtain a new session.  
            This response covers multiple possible authentication-related errors such as invalid token type, missing cookie, or user/session mismatch.
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
            Set-Cookie:
              $ref: "#/components/headers/InvalidateAuthenticationCookies"
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/RefreshTokenInvalidSessionError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/AuthenticationTokenNotFoundError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/RefreshTokenTypeError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/AuthenticationTokenUserNotFoundError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/RefreshTokenExpiredSessionError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/AuthenticationTokenSessionMismatchError"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/AuthenticationTokenInvalidTokenErorr"
                  - $ref: "../spec/schemas/reusable/errors/openapi.yaml/components/schemas/AuthenticationTokenExpiredError"
components:
  schemas:
    UserRegistrationRequestBody:
      type: object
      required:
        - name
        - email
        - password
        - confirmPassword
      properties:
        name:
          type: string
          description: The user's full name
          minLength: 1
          maxLength: 64
          example: John Doe
        email:
          type: string
          format: email
          minLength: 1
          maxLength: 64
          example: john.doe@example.com
        password:
          type: string
          minLength: 8
          pattern: ^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{}|\\;:\'",.<>/?]).{8,}$
          description: Must start with a capital letter and contain at least one special character
          example: Password@123
        confirmPassword:
          type: string
          minLength: 8
          pattern: ^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{}|\\;:\'",.<>/?]).{8,}$
          description: Must match the password field
          example: Password@123
    UserLoginRequestBody:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          minLength: 1
          maxLength: 64
          example: john.doe@example.com
        password:
          type: string
          minLength: 8
          pattern: ^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{}|\\;:\'",.<>/?]).{8,}$
          description: Must start with a capital letter and contain at least one special character
          example: Password@123
    ForgotPasswordRequestBody:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          example: john.doe@gmail.com
    ResetPasswordRequestBody:
      type: object
      required:
        - verificationCode
        - password
      properties:
        verificationCode:
          type: string
          minLength: 1
          maxLength: 64
          example: 8ee6af17747140d8951121739
        password:
          type: string
          minLength: 8
          pattern: ^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{}|\\;:\'",.<>/?]).{8,}$
          description: Must start with a capital letter and contain at least one special character
          example: Password@123
    UserData:
      type: object
      required:
        - _id
        - name
        - email
        - isEmailVerified
        - userPreferences
        - createdAt
        - updatedAt
      properties:
        _id:
          type: string
          example: 6904fb216bdaf225b3726294
        name:
          type: string
          example: user
        email:
          type: string
          example: marinescua914@gmail.com
        isEmailVerified:
          type: boolean
          example: false
        userPreferences:
          type: object
          required:
            - enable2FA
            - emailNotification
          properties:
            enable2FA:
              type: boolean
              example: false
          emailNotification:
            type: boolean
            example: true
        createdAt:
          type: string
          format: date-time
          example: 2025-10-31T18:08:33.919Z
        updatedAt:
          type: string
          format: date-time
          example: 2025-10-31T18:08:33.919Z
    ResponseMetadata:
      type: object
      required:
        - timestamp
        - requestId
      properties:
        timestamp:
          type: string
          format: date-time
          example: 2025-10-31T18:08:35.135Z
        requestId:
          type: string
          example: 627c83c6ac314a94bd9348d78
        count:
          type: number
    RegistrationSuccessReponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [201]
          example: 201
        message:
          type: string
          example: Registration successful. A verification email has been sent to your email address.
        data:
          type: object
          properties:
            user:
              $ref: "#/components/schemas/UserData"
            isVerificationEmailSend:
              type: boolean
              example: true
            nextStep:
              type: string
              enum: ["CONFIRM_SIGN_UP"]
              example: CONFIRM_SIGN_UP
            metadata:
              $ref: "#/components/schemas/ResponseMetadata"
    LoginEmailVerificationPendingResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Authentication pending, your email address has not yet been verified. Please confirm your email to proceed.
        data:
          type: object
          properties:
            nextStep:
              type: string
              enum: ["CONFIRM_SIGN_UP"]
              example: CONFIRM_SIGN_UP
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    LoginSuccessResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Authentication successful, You have been signed in successfully.
        data:
          type: object
          required:
            - mfaRequired
            - nextStep
            - user
          properties:
            user:
              $ref: "#/components/schema/UserData"
            nextStep:
              type: string
              enum: ["OK"]
              example: OK
            mfaRequired:
              type: boolean
              enum: [false]
              example: false
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    MFAPendingResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Two-factor authentication required. Please enter your verification code to complete this process.
        data:
          type: object
          required:
            - mfaRequired
            - nextStep
          properties:
            nextStep:
              type: string
              enum: ["MFA_REQUIRED"]
              example: MFA_REQUIRED
            mfaRequired:
              type: boolean
              enum: [true]
              example: true
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    EmailConfirmedSuccessResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Email address successfully verified. You can now proceed to login.
        data:
          type: object
          required:
            - nextStep
          properties:
            nextStep:
              type: string
              enum: ["CONFIRMED_EMAIL_RETURN_TO_LOGIN"]
              example: CONFIRMED_EMAIL_RETURN_TO_LOGIN
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    ForgotPasswordSuccessResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Password reset request successfully processed. Please check your email for further instructions.
        data:
          type: object
          required:
            - nextStep
            - mfaRequired
          properties:
            nextStep:
              type: string
              enum: ["OK"]
              example: OK
            mfaRequired:
              type: boolean
              enum: [false]
              example: false
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    ResetPasswordSuccessResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Password reset completed. If you didn’t request this change, please contact support immediately.
        data:
          type: object
          required:
            - nextStep
          properties:
            nextStep:
              type: string
              enum: ["OK"]
              example: OK
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"
    RefreshTokenEndpointSuccessResponse:
      type: object
      required:
        - success
        - statusCode
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          enum: [true]
          example: true
        statusCode:
          type: integer
          enum: [200]
          example: 200
        message:
          type: string
          example: Access token successfully refreshed. Your session remains active.
        data:
          type: object
          required:
            - nextStep
          properties:
            nextStep:
              type: string
              enum: ["OK"]
              example: OK
          metadata:
            $ref: "#/components/schemas/ResponseMetadata"

  headers:
    XRequestId:
      description: Unique request identifier for tracing and debugging
      schema:
        type: string
        example: 627c83c6ac314a94bd9348d78
    AuthenticationCookies:
      description: |
        Multiple cookies may be set in this response:
        1. accessToken — HTTP-only access token
        2. refreshToken — HTTP-only refresh token
        3. mfaToken — HTTP-only MFA token (if required)
      schema:
        type: string
      example: |
        accessToken=eyJhbGciOi...; Path=/; HttpOnly; Secure; SameSite=Strict; Expires=Wed, 03 Nov 2025 20:00:00 GMT,
        refreshToken=eyJhbGciOi...; Path=/auth/refresh; HttpOnly; Secure; SameSite=Strict; Expires=Wed, 03 Nov 2025 20:00:00 GMT
        mfaToken=eyJhbGciOi...; Path=/mfa; HttpOnly; Secure; SameSite=Strict; Expires=Wed, 03 Nov 2025 20:00:00 GMT
    MFATokenCookie:
      description: |
        HTTP-only MFA token cookie used for two-factor authentication.
        This cookie must be included in subsequent requests to complete the MFA step.
      schema:
        type: string
      example: |
        mfaToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; Path=/mfa; HttpOnly; Secure; SameSite=Strict; Expires=Wed, 03 Nov 2025 20:00:00 GMT
    InvalidateAuthenticationCookies:
      description: |
        Multiple authentication cookies may be cleared in this response to invalidate any existing sessions.
        This ensures that previously issued tokens become unusable and the user must log in again.
        The following cookies are invalidated:
        1. accessToken — HTTP-only access token
        2. refreshToken — HTTP-only refresh token
      schema:
        type: string
      example: |
        accessToken=; Path=/; HttpOnly; Secure; SameSite=Strict; Expires=Thu, 01 Jan 1970 00:00:00 GMT
        refreshToken=; Path=/auth/refresh; HttpOnly; Secure; SameSite=Strict; Expires=Thu, 01 Jan 1970 00:00:00 GMT
  securitySchemes:
    AccessTokenCokie:
      type: apiKey
      in: cookie
      name: accessToken
    RefreshTokenCokie:
      type: apiKey
      in: cookie
      name: accessToken
